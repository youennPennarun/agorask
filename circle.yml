machine:
  node:
    version: 6.1.0
  environment:
    GRADLE_OPTS: '-Dorg.gradle.jvmargs="-Xmx3072m -XX:+HeapDumpOnOutOfMemoryError"'
    YARN_VERSION: 0.18.1
    PATH: "${PATH}:${HOME}/.yarn/bin:${HOME}/${CIRCLE_PROJECT_REPONAME}/node_modules/.bin"
    MONGO_URL: mongodb://localhost/agorask
    KEYSTORE_ENCR_1: i6V6Ibes9jthI/QpymfqH3pWEqAVOwT7xohKL/ttL/CXpBnigPmvoUSe4mhblfcylLLPsukcfpQVwezMNeUV/VSyy3JQbimINmwuztnnMDtM4Sjz6DfNy8S60uqUB2yu1V8m5WCYeeXwXFuIe6iur3iqrpSRjpwbAGwOeVP/0B+NLe5ppIzZLSIjIRv0bQUl9lXmXE3Hcw8qmWP4wwRMHMfB9bPNc2UPa5BS5lUxzAI53c4/P/p9QpzRbY5D3T2EPWBnteYZxJH1IhWooU2wHSVpl0glw8YpvlTCb9K8b78JgKRone0HMG6YmRk8qDwIanJV/2AQKrcOyRccAPkxZ1OHNvaMtgLbzlmDLZ8+NJssuGLMOwxOtBnh9jSyrERruRp/GFgoyL8YW+ZEmPY5WlGg3MKYSMkawat30m/+9J1hw8rD5DrpVXTSclMTV2XzluSIst5DBk5Ewsk1QLbt5NVqL6Iz6/MJTVIluvPinNAWWW6LsTE87KjsNUV3rxyozCw5P0tUv3KciSUKU/+skC4h6FDKqDOp2yDLSPtXTxQfbaS6Tp6Wptw0yaxLtS0ExY1jz2BOoCL2LNsOptfiG7nglo2BwnIqJBkhzMoEwCRuKM6z1DSU4gLhpgL+JGxaPcjqZWuzI8Ynn1aZCZNCy2PAAJsSoWrybRUutYb9ryI=
    KEYSTORE_ENCR_2: ZxRCwfXRf64aCy4IeqGPs2Las/mggIFRubSlzj8vRAIwhDh6LGZNG0BWas6DAiMM3MIsrOgKiPzdjhb0pG4KlpKj6oDtWGlCzEup3NNz06KGs7GblfKQIaZ9MyU3YFACkeNMOobLvDuxBASO3UUWUkW7sH8IY5lqK5aa4Ppv2WyzC06sqYC2yazTYFcVSpNIxk6emIUuEsr1drXnOkJ0sU0BixojpNuC5FeC+HCHMLUxhmx+Ru7E4kZJ/EmbrADVNrLVV3d/jNBX2nrlQZ4JV3RDv0ZAIecQvM60JAz5/x4AjrI7nBCVPfkoQjCkvvyd2A2wJ5170ccvC8Px6eFEW7TmgraR46DcGyvh4K0EDwGQjEUnlJcBdGtXNjCyKsFazcJDThYnsOR96ofOWogpWaMEK9uCWR87C0/fzOq5MK28+WXfAqkJrQn2CVMxYJ7EQsyqQGoi3lbAbE65pb+es8QzLCMZPUaamXpxL8mtJrDRBQfG4KaC0t+ZW07lury40EUvinmATAbGzpewsPRaMDvV/e8Rvn/5olwX/sf/xTlylWhX4QJqHKHltnV5Zg3KPP6tAa0MzHzUBtm1RJbNSXKfwZ34g3s6zwcYheZfuyI8zxKyrGb6ZNBmwZLsIHVxBoZFcEG5QfgZj2qo3POPsiDKxiISdVbEQFWCC/bMRTo=
    KEYSTORE_ENCR_3: M5TU4Cb5R+6s7QOQQef4aAUXO8Cqii0pfsOkyE8EsDXOyIb5dv3w4DDPY/3Euqy0CqFXo7KnlS0oA0yUTGQGthChBxvOIwZLWgQ1diASXt3YxqJWQyKHGxXrkaWmCiM906YgvSN6g9VpRnpl6IOXHpKblbHLz0VMI44SxKfTwJkm6fvb9RoU+Khaxn8fTZspgnBdF/IQ87Mvp939fl1EQnHDyanDsDApHgj4lxoDLoLaXQCQ6TFk5jO1WM1U5Ih9OLOiOvFUydT9DHgD0IfgdGjj2D3vevqxozxjNDXdRO5TDg0Bfc7kHoLMdc3kiA5Y+tVoYR5ezQUH1VeDRetgUwfA6Q/elhGaNC60N1BzzQ1HD8IogQRO7IMnaqxBXUJzNI1ykilTE3bAVL82SCgX+0qEXjkmVi83b7HmIabuZdhFRJvGvw/JqodRj76/N5D3WXr5DLPOD5d6+JNtZuhbEvypJz76ixrHenAC4GuT7yfNq8HnTXBPJMj18ln+ZxKIrlpVm6rHch5eqsgnlbKVKthc9ohVuRKvf5wurhQ21REN14/lgSc6AwW/41ZAisLHrPyMejPENl7erWDVKr0t3iUjApTHgK66xLvHaZn8HPGj1bYF+TpKEL6+c7VaLUtrelXFSDnoRei8BXC6bk8d8gIgLiC7NEgZ7wIte/7+SHE=
dependencies:
  pre: 
    - |
      if [[ ! -e ~/.yarn/bin/yarn || $(yarn --version) != "${YARN_VERSION}" ]]; then
        curl -o- -L https://yarnpkg.com/install.sh | bash -s -- --version $YARN_VERSION
      fi
    - ./tools/android_deps.sh
    - yarn global add appium appium
    - yarn:
        pwd:
          tests/app
  cache_directories:
    - ~/.yarn
    - ~/.cache/yarn
    - /usr/local/android-sdk-linux

test:
  pre:
    - emulator -avd testAVD -no-window:
        background: true
        parallel: true
    - ./gradlew assembleRelease --stacktrace --info:
        timeout: 3600
        pwd:
          mobile_app/android
    - circle-android wait-for-boot
  override:
    - appium -p 4723:
        background: true
    - sleep 5
    - npm start:
        pwd:
          tests/app

deployment:
  development:
    branch: development
    commands:
      - git remote add heroku git@heroku.com:agorask-dev.git
      - git push heroku `git subtree split --prefix server master`:master --force
      - openssl aes-256-cbc -d -in release.keystore.enc -out mobile_app/android/app/release.keystore -k $KEYSTORE_ENCR_KEY
      - npm install && node deployApplication.js -b $CIRCLE_BRANCH -u $CIRCLE_COMPARE_URL:
          timeout: 3600
          pwd:
            tools/buildApplication
  production:
    branch: master
    commands:
      - git remote add heroku git@heroku.com:agorask.git
      - git push heroku `git subtree split --prefix server master`:master --force
      - openssl aes-256-cbc -d -in release.keystore.enc -out mobile_app/android/app/release.keystore -k $KEYSTORE_ENCR_KEY
      - npm install && node deployApplication.js -b $CIRCLE_BRANCH -u $CIRCLE_COMPARE_URL:
          timeout: 3600
          pwd:
            tools/buildApplication